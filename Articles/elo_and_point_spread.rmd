---
title: "Calculating the Implied Spread Using Elo"
author: "Kyle Bennison"
date: "10/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Join Historic Elo Ratings with Game Results from 2000-2021

```{r include=FALSE}
source("https://raw.githubusercontent.com/kylebennison/staturdays/master/Production/source_everything.R")

elo <- get_elo(2000, 2021)

games <- get_games(2000, 2021)
```

So we have elo ratings from 2000-2021. They include the date of the game, but it's the date of the game and the elo rating after that game is done.
We really want the elo rating before the game's played, so we'll join games and elo using the elo of the game before the current game.

```{r tidy=TRUE}
slice_sample(elo, n = 10L)

slice_sample(games, n = 10L)

e2 <- elo %>% 
  group_by(team) %>% 
  mutate(join_date = lead(date, n = 1L, order_by = date))
```

Next, we'll do the join, joining first for the home teams and then the away teams.

```{r}
games_elo <- games %>% 
  mutate(start_date = lubridate::as_datetime(start_date)) %>% 
  left_join(e2, by = c("start_date" = "join_date",
                       "home_team" = "team")) %>% 
  left_join(e2, by = c("start_date" = "join_date",
                       "away_team" = "team"),
            suffix = c("_home", "_away"))
```

Now we'll calculate the difference between the home and away teams in elo rating, including 55 points for the elo spread. Then we'll calculate the actual spread in these games after they were played.

```{r}
ge2 <- games_elo %>%
  mutate(home_elo_adv = elo_rating_home + if_else(neutral_site == TRUE, 0, 55) - elo_rating_away,
         final_home_spread = home_points - away_points)
```

## Plotting the relationship

Now let's look at the relationship between the elo rating differences and the points spread.

```{r echo=FALSE, warning=FALSE}
ge2 %>% 
  ggplot(aes(x = home_elo_adv, y = final_home_spread)) +
  geom_point(alpha = .1, color = staturdays_colors("light_blue")) +
  geom_smooth(color = staturdays_colors("orange")) +
  staturdays_theme +
  theme(panel.grid.major = element_line(color = "lightgrey")) +
  labs(title = "Elo and Spread 2000-2021",
       subtitle = "Elo advantage includes built-in home-field advantage worth around 3 points",
       x = "Home Elo Point Advantage/Disadvantage",
       y = "Home Win/Loss Point Margin")
```

So we definitely have a clear linear relationship here. That's good. We're going to have a significant model. However the problem is the variance of the spread. It's huge. The error on any given spread is going to be really wide. Let's build the model and see

```{r}
model <- lm(final_home_spread ~ home_elo_adv, data = ge2)
summary(model)
```

Home margin = home_elo_adv * .05 + .92
So 1 point of home margin equals  20 elo points advantage.
Note, if i exclude the 55 elo point margin, it adds it into the intercept anyway as a 3.59 point intercept. So our home-field adv. may actually be too low.

Now let's use it to see what the predicted spread would be using elo ratings.

```{r include=FALSE}
ge_predictions <- ge2 %>% 
  mutate(pred_home_spread = predict(model, newdata = ge2)) %>% 
  select(home_team, away_team, home_elo_adv, home_points, away_points, final_home_spread, pred_home_spread)

slice_sample(ge_predictions, n = 10L)
```
```{r warning=FALSE}
ge_predictions %>% 
  ggplot(aes(x = final_home_spread, y = pred_home_spread)) +
  geom_point(alpha = .1) +
  geom_smooth() +
  labs(title = "Predicted vs. Actual Spreads",
       subtitle = paste0("Average Residual of ", round(mean(abs(residuals(model))), 2), " points per game"))
```

So really this is the exact same graph, but we're just applying the model to the data (and the same data we trained the model on, which is generally a no-no). So even though the model has seen this data before, this is the best it can do given the elo margin, leaving a lot of variability (almost 14 points to be exact.)

So we can't really use this much unless our spread is > 13 points different from the vegas spread, which should very rarely be the case. And even then, we'd wonder whether vegas knows something we don't with such a large gap in predictions.






